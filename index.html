<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>カウンター</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>

<script>
    const config = {
      type: Phaser.AUTO,
      width: 300,
      height: 480,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
      },
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };

    const game = new Phaser.Game(config);

    let startButton, stopButton, counterText, messageText;
    let isCounting = false;
    let startTime = 0;
    let overlay;  // オーバーレイ用 Graphics オブジェクト

    function preload() {
      // 必要なアセットがあれば読み込み
    }

    function create() {
      const gw = this.scale.width;
      const gh = this.scale.height;

      // 背景色を設定
      this.cameras.main.setBackgroundColor('#f5f5f5');

      // 画面上部に初期のメッセージを配置
      messageText = this.add.text(gw / 2, 20, '10秒ちょうどで止めてください', {
        fontSize: '18px',
        color: '#000'
      });
      messageText.setOrigin(0.5, 0);
      messageText.setPadding(0, 5, 0, 0);

      // 画面下中央に配置するための座標
      const buttonX = gw / 2;
      const buttonY = gh - 20;

      // スタートボタン（初期状態：表示）
      startButton = this.add.text(buttonX, buttonY, 'スタート', {
        fontSize: '32px',
        color: '#0f0',
        backgroundColor: '#333'
      });
      startButton.setOrigin(0.5, 1);
      startButton.setPadding(0, 5, 0, 0);
      startButton.setInteractive().on('pointerdown', () => {
        startButton.setVisible(false);
        stopButton.setVisible(true);
        // 計測開始時刻を記録
        startTime = this.time.now;
        isCounting = true;
        // メッセージを初期状態に戻す
        messageText.setText('10秒ちょうどで止めてください');
      });

      // ストップボタン（初期状態：非表示）
      stopButton = this.add.text(buttonX, buttonY, 'ストップ', {
        fontSize: '32px',
        color: '#f00',
        backgroundColor: '#ccc'
      });
      stopButton.setOrigin(0.5, 1);
      stopButton.setPadding(0, 5, 0, 0);
      stopButton.setVisible(false);
      stopButton.setInteractive().on('pointerdown', () => {
        stopButton.setVisible(false);
        startButton.setVisible(true);
        isCounting = false;
        // ストップ時の経過時間を計算
        const elapsed = this.time.now - startTime;
        // ±50ms の許容範囲で10秒ちょうどとみなす
        if (Math.abs(elapsed - 10000) < 50) {
          messageText.setText('おめでとう！');
        } else {
          messageText.setText('がんばれ！');
        }
      });

      // 画面中央にカウンター用のテキストを配置
      counterText = this.add.text(gw / 2, gh / 2, '0.00', {
        fontSize: '96px',
        color: '#000',
        backgroundColor: '#ffffe0'
      });
      counterText.setOrigin(0.5, 0.5);

      // オーバーレイ用の Graphics オブジェクトを作成し、カウンターの上に表示するため depth を上げる
      overlay = this.add.graphics();
      overlay.setDepth(1);
    }

    function update(time, delta) {
      if (isCounting) {
        const elapsed = time - startTime; // 経過時間（ms）
        const seconds = Math.floor(elapsed / 1000);
        const cs = Math.floor((elapsed % 1000) / 10); // 100分の1秒に変換
        counterText.setText(`${seconds}.${("0" + cs).slice(-2)}`);

        // 3秒以降、オーバーレイでカウンターの上側から隠す
        let hidePercent = 0;
        if (elapsed >= 3000) {
          // 3秒～5秒の間で0～1に変化。5秒以降は完全に非表示
          hidePercent = Math.min((elapsed - 3000) / 2000, 1);
        }
        // counterText の位置とサイズからオーバーレイ用の矩形を計算
        const textWidth = counterText.width;
        const textHeight = counterText.height;
        const cx = counterText.x;
        const cy = counterText.y;
        const rectX = cx - textWidth / 2;
        const rectY = cy - textHeight / 2;
        const overlayHeight = textHeight * hidePercent;
        // オーバーレイはテキストの上部から隠す
        const overlayY = rectY;

        // オーバーレイ Graphics を更新（例：ゴールド色で表示）
        overlay.clear();
        overlay.fillStyle(0xffd700, 1);
        overlay.fillRect(rectX, overlayY, textWidth, overlayHeight);
      }
      else {
        // isCounting が false の場合、オーバーレイをクリア（カウンター全体表示）
        overlay.clear();
      }
    }
</script>

</body>
</html>
